%%
%% Beginning of file 'sample61.tex'
%%
%% Modified 2016 September
%%
%% This is a sample manuscript marked up using the
%% AASTeX v6.1 LaTeX 2e macros.
%%
%% AASTeX is now based on Alexey Vikhlinin's emulateapj.cls 
%% (Copyright 2000-2015).  See the classfile for details.

%% AASTeX requires revtex4-1.cls (http://publish.aps.org/revtex4/) and
%% other external packages (latexsym, graphicx, amssymb, longtable, and epsf).
%% All of these external packages should already be present in the modern TeX 
%% distributions.  If not they can also be obtained at www.ctan.org.

%% The first piece of markup in an AASTeX v6.x document is the \documentclass
%% command. LaTeX will ignore any data that comes before this command. The 
%% documentclass can take an optional argument to modify the output style.
%% The command below calls the preprint style  which will produce a tightly 
%% typeset, one-column, single-spaced document.  It is the default and thus
%% does not need to be explicitly stated.
%%
%%
%% using aastex version 6.1
\documentclass[twocolumn]{aastex61}

\usepackage{xspace}

%% The default is a single spaced, 10 point font, single spaced article.
%% There are 5 other style options available via an optional argument. They
%% can be envoked like this:
%%
%% \documentclass[argument]{aastex61}
%% 
%% where the arguement options are:
%%
%%  twocolumn   : two text columns, 10 point font, single spaced article.
%%                This is the most compact and represent the final published
%%                derived PDF copy of the accepted manuscript from the publisher
%%  manuscript  : one text column, 12 point font, double spaced article.
%%  preprint    : one text column, 12 point font, single spaced article.  
%%  preprint2   : two text columns, 12 point font, single spaced article.
%%  modern      : a stylish, single text column, 12 point font, article with
%% 		  wider left and right margins. This uses the Daniel
%% 		  Foreman-Mackey and David Hogg design.
%%
%% Note that you can submit to the AAS Journals in any of these 6 styles.
%%
%% There are other optional arguments one can envoke to allow other stylistic
%% actions. The available options are:
%%
%%  astrosymb    : Loads Astrosymb font and define \astrocommands. 
%%  tighten      : Makes baselineskip slightly smaller, only works with 
%%                 the twocolumn substyle.
%%  times        : uses times font instead of the default
%%  linenumbers  : turn on lineno package.
%%  trackchanges : required to see the revision mark up and print its output
%%  longauthor   : Do not use the more compressed footnote style (default) for 
%%                 the author/collaboration/affiliations. Instead print all
%%                 affiliation information after each name. Creates a much
%%                 long author list but may be desirable for short author papers
%%
%% these can be used in any combination, e.g.
%%
%% \documentclass[twocolumn,linenumbers,trackchanges]{aastex61}

%% AASTeX v6.* now includes \hyperref support. While we have built in specific
%% defaults into the classfile you can manually override them with the
%% \hypersetup command. For example,
%%
%%\hypersetup{linkcolor=red,citecolor=green,filecolor=cyan,urlcolor=magenta}
%%
%% will change the color of the internal links to red, the links to the
%% bibliography to green, the file links to cyan, and the external links to
%% magenta. Additional information on \hyperref options can be found here:
%% https://www.tug.org/applications/hyperref/manual.html#x1-40003

%% If you want to create your own macros, you can do so
%% using \newcommand. Your macros should appear before
%% the \begin{document} command.
%%
\newcommand{\vdag}{(v)^\dagger}
\newcommand\aastex{AAS\TeX}
\newcommand\latex{La\TeX}
\newcommand{\project}[1]{\textsl{#1}}
\newcommand{\nustar}{\project{NuSTAR}\xspace}
\newcommand{\fermi}{\project{Fermi}\xspace}
\newcommand{\rxte}{\project{RXTE}\xspace}
\newcommand{\xmm}{\project{XMM-Newton}\xspace}
\newcommand{\rosat}{\project{ROSAT}\xspace}
\newcommand{\swift}{\project{Swift}\xspace}
\newcommand{\astrosat}{\project{Astrosat}\xspace}
\newcommand{\ixpe}{\project{IXPE}\xspace}
\newcommand{\nicer}{\project{NICER}\xspace}
\newcommand{\sref}{Section~\ref}
\newcommand{\deadt}{\ensuremath{t_d}\xspace}

\newcommand{\given}{\ensuremath{\,|\,}\xspace}
\newcommand{\dd}{\ensuremath{\mathrm{d}}\xspace}
\newcommand{\counts}{\ensuremath{y}\xspace}
\newcommand{\rms}{\ensuremath{\mathrm{r.m.s.}}\xspace}
\newcommand{\pars}{\ensuremath{\theta}\xspace}
\newcommand{\mean}{\ensuremath{\lambda}\xspace}
\newcommand{\likelihood}{\ensuremath{{\mathcal L}}\xspace}
\newcommand{\Poisson}{\ensuremath{{\mathcal P}}\xspace}
\newcommand{\Uniform}{\ensuremath{{\mathcal U}}\xspace}

\newcommand{\Normal}{\ensuremath{{\mathcal N}}\xspace}
\newcommand{\bg}{\ensuremath{\mathrm{bg}}\xspace}
\newcommand{\word}{\ensuremath{\phi}\xspace}

%% Reintroduced the \received and \accepted commands from AASTeX v5.2
\received{XXXX}
\revised{XXXX}
\accepted{\today}
%% Command to document which AAS Journal the manuscript was submitted to.
%% Adds "Submitted to " the arguement.
\submitjournal{ApJL}

%% Mark up commands to limit the number of authors on the front page.
%% Note that in AASTeX v6.1 a \collaboration call (see below) counts as
%% an author in this case.
%
%\AuthorCollaborationLimit=3
%
%% Will only show Schwarz, Muench and "the AAS Journals Data Scientist 
%% collaboration" on the front page of this example manuscript.
%%
%% Note that all of the author will be shown in the published article.
%% This feature is meant to be used prior to acceptance to make the
%% front end of a long author article more manageable. Please do not use
%% this functionality for manuscripts with less than 20 authors. Conversely,
%% please do use this when the number of authors exceeds 40.
%%
%% Use \allauthors at the manuscript end to show the full author list.
%% This command should only be used with \AuthorCollaborationLimit is used.

%% The following command can be used to set the latex table counters.  It
%% is needed in this document because it uses a mix of latex tabular and
%% AASTeX deluxetables.  In general it should not be needed.
%\setcounter{table}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% The following section outlines numerous optional output that
%% can be displayed in the front matter or as running meta-data.
%%
%% If you wish, you may supply running head information, although
%% this information may be modified by the editorial offices.
\shorttitle{The Fourier Amplitude Difference correction for periodograms}
\shortauthors{Bachetti \& Huppenkothen}
%%
%% You can add a light gray and diagonal water-mark to the first page 
%% with this command:
% \watermark{text}
%% where "text", e.g. DRAFT, is the text to appear.  If the text is 
%% long you can control the water-mark size with:
%  \setwatermarkfontsize{dimension}
%% where dimension is any recognized LaTeX dimension, e.g. pt, in, etc.
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% This is the end of the preamble.  Indicate the beginning of the
%% manuscript itself with \begin{document}.

\begin{document}

\title{No time for dead time - Use the Fourier amplitude differences to normalize dead time-affected periodograms}

%% LaTeX will automatically break titles if they run longer than
%% one line. However, you may use \\ to force a line break if
%% you desire. In v6.1 you can include a footnote in the title.

%% A significant change from earlier AASTEX versions is in the structure for 
%% calling author and affilations. The change was necessary to implement 
%% autoindexing of affilations which prior was a manual process that could 
%% easily be tedious in large author manuscripts.
%%
%% The \author command is the same as before except it now takes an optional
%% arguement which is the 16 digit ORCID. The syntax is:
%% \author[xxxx-xxxx-xxxx-xxxx]{Author Name}
%%
%% This will hyperlink the author name to the author's ORCID page. Note that
%% during compilation, LaTeX will do some limited checking of the format of
%% the ID to make sure it is valid.
%%
%% Use \affiliation for affiliation information. The old \affil is now aliased
%% to \affiliation. AASTeX v6.1 will automatically index these in the header.
%% When a duplicate is found its index will be the same as its previous entry.
%%
%% Note that \altaffilmark and \altaffiltext have been removed and thus 
%% can not be used to document secondary affiliations. If they are used latex
%% will issue a specific error message and quit. Please use multiple 
%% \affiliation calls for to document more than one affiliation.
%%
%% The new \altaffiliation can be used to indicate some secondary information
%% such as fellowships. This command produces a non-numeric footnote that is
%% set away from the numeric \affiliation footnotes.  NOTE that if an
%% \altaffiliation command is used it must come BEFORE the \affiliation call,
%% right after the \author command, in order to place the footnotes in
%% the proper location.
%%
%% Use \email to set provide email addresses. Each \email will appear on its
%% own line so you can put multiple email address in one \email call. A new
%% \correspondingauthor command is available in V6.1 to identify the
%% corresponding author of the manuscript. It is the author's responsibility
%% to make sure this name is also in the author list.
%%
%% While authors can be grouped inside the same \author and \affiliation
%% commands it is better to have a single author for each. This allows for
%% one to exploit all the new benefits and should make book-keeping easier.
%%
%% If done correctly the peer review system will be able to
%% automatically put the author and affiliation information from the manuscript
%% and save the corresponding author the trouble of entering it by hand.

\correspondingauthor{Matteo Bachetti}
\email{bachetti@oa-cagliari.inaf.it}

\author[0000-0002-4576-9337]{Matteo Bachetti}
\affil{INAF-Osservatorio Astronomico di Cagliari, via della Scienza 5, I-09047 Selargius (CA)}

\author{Daniela Huppenkothen}
\affiliation{Center for Data Science, New York University, 60 5h Avenue, 7th Floor, New York, NY 10003 }
\affiliation{Center for Cosmology and Particle Physics, Department of Physics, New York University, 4 Washington Place, New York, NY 10003, USA}

%% Note that the \and command from previous versions of AASTeX is now
%% depreciated in this version as it is no longer necessary. AASTeX 
%% automatically takes care of all commas and "and"s between authors names.

%% AASTeX 6.1 has the new \collaboration and \nocollaboration commands to
%% provide the collaboration status of a group of authors. These commands 
%% can be used either before or after the list of corresponding authors. The
%% argument for \collaboration is the collaboration identifier. Authors are
%% encouraged to surround collaboration identifiers with ()s. The 
%% \nocollaboration command takes no argument and exists to indicate that
%% the nearby authors are not part of surrounding collaborations.

%% Mark off the abstract in the ``abstract'' environment. 
\begin{abstract}
Dead time affects many of the instruments used in X-ray astronomy, by producing a strong distortion in power density spectra. This can make it difficult to model the aperiodic variability of the source or look for quasi-periodic oscillations.
Whereas in some instruments a simple a-priori correction for dead time-affected power spectra is possible, 
this is not the case for others such as \nustar, where the dead time is non-constant and long ($\sim$2.5\,ms).
\citet{Bachetti+15} suggested the cospectrum obtained from light curves of independent detectors within the same instrument as a possible way out, but this solution has always only been a partial one: the measured \rms was still affected by dead time, because the width of the power distribution of the cospectrum was modulated by dead time in a frequency-dependent way.

In this Letter we suggest a new, powerful method to normalize deadtime-affected cospectra and power density spectra. Our approach uses the difference of the Fourier amplitudes from two independent detectors to characterize and filter out the effect of dead time. This method is crucially important for the accurate modeling of periodograms derived from instruments affected by dead time on board current missions like \nustar and \astrosat, but also future missions such as \ixpe.
\end{abstract}

%% Keywords should appear after the \end{abstract} command. 
%% See the online documentation for the full list of available subject
%% keywords and the rules for their use.
\keywords{X-rays: binaries --- 
X-rays: general --- methods: data analysis --- methods: statistical}

%% From the front matter, we move on to the body of the paper.
%% Sections are demarcated by \section and \subsection, respectively.
%% Observe the use of the LaTeX \label
%% command after the \subsection to give a symbolic KEY to the
%% subsection for cross-referencing in a \ref command.
%% You can use LaTeX's \ref and \label commands to keep track of
%% cross-references to sections, equations, tables, and figures.
%% That way, if you change the order of any elements, LaTeX will
%% automatically renumber them.

%% We recommend that authors also use the natbib \citep
%% and \citet commands to identify citations.  The citations are
%% tied to the reference list via symbolic KEYs. The KEY corresponds
%% to the KEY in the \bibitem in the reference list below. 

%%%%%%%%%%%%%%%%%%%%%%%% SECTION 1 %%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction} \label{sec:intro}
Dead time is an unavoidable and common issue of photon-counting instruments.
It is the time $\deadt$ that the instrument takes to process an event and be ready for the next event.
In most current astronomical photon-counting X-ray missions, dead time is of the \textit{non-paralyzable} kind, meaning that the instrument does not accept new events during dead time, avoiding a complete lock of the instrument if the incident rate of photons is higher than $1/\deadt$.
Being roughly energy-independent, dead time is not usually an issue for spectroscopy, as it only affects the maximum rate of photons that can be recorded, so it basically only increases the observing time needed for high quality spectra.
For timing analysis, the effect of dead time is far more problematic.
The periodogram, commonly referred to as power density spectrum (PDS)%
\footnote{here we will use the term PDS for the actual source power spectrum, and \textit{periodogram} to indicate our estimate of it, or otherwise said, the realization of the ``real'' power spectrum we observe in the data}%
, which is the most widely used statistical tool to investigate rapid variability, is heavily distorted by dead time, with a characteristic pattern similar to a damped oscillator.
This pattern is stronger for brighter sources, and it is often not possible to disentangle this power spectral distortion due to dead time and the broadband noise components characterizing the emission of accreting systems.
In the special case where dead time is constant, its shape can be modeled precisely \citep{Zhang+95,Vikhlinin+94}.
However, dead time is often different on an event-to-event basis, and it is not obvious how to model it precisely, also because the information on dead time is often incomplete in the data files distributed by HEASARC%
\footnote{Whereas in principle this information could be obtained by using the PRIOR column in the unfiltered event files for some missions, the live time given in this column is affected by events that are not recorded in the file, like shield vetos in the case of \nustar, and the estimate of dead time is necessarily uncertain}%
.
For a more thorough discussion about different dead time behaviors see \citet{Zhang+95}.

When using data from missions carrying two or more \textit{identical and independent} detectors like \nustar, \citet{Bachetti+15} proposed an approach to mitigate instrumental effects like dead time exploiting this redundancy: 
where in standard analysis, light curves of multiple detectors are summed before Fourier transforming the summed light curve, 
it is possible to instead Fourier-transform the signal of two independent detectors and combine the Fourier amplitudes in a \textit{cospectrum} -- the real part of the cross spectrum -- instead of the periodogram. 
Since dead time is uncorrelated between the two detectors, the resulting powers have a mean white noise level fixed to 0, which resolves the first and most problematic issue created by dead time (see details in \citealt{Bachetti+15}); however, the resulting powers no longer follow the statistical distribution expected for power spectra, and their probability distribution is frequency-dependent.
Whereas a noise cospectrum in the absence of dead time would follow a Laplace distribution (Huppenkothen and Bachetti, sub.),
dead time affects the width of the probability distribution for cospectral powers and modulates the measured \rms proportionally to the distortion acted on power spectra.
In this Letter, we show a method to precisely recover the shape of the power density spectrum by looking at the difference of the Fourier amplitudes of the light curves of two independent detectors.
This difference, in fact, contains information on the uncorrelated noise produced by dead time, but not on the source-related  signal which is correlated between the two detectors.
This allows to disentangle the effects of dead time from those of the source variability.

In \sref{sec:data} we briefly describe our data analysis and simulation setup.
In \sref{sec:fourierdiff} we show that, in the absence of dead time, the Fourier amplitudes of two independent detectors contain the sum of the correlated signal (the source signal) and uncorrelated noise (detector-related noise), and that their difference eliminates the source part. 
In \sref{sec:wndeadtime} we show that, in the presence of dead time, the difference of the Fourier amplitude still eliminates the source signal but retains information on dead time effects.
In \sref{sec:correction} we show that this can be used to recover the dead noise-free power spectrum.

%%%%%%%%%%%%%%%%%%%%%%%% SECTION 2 %%%%%%%%%%%%%%%%%%%%%%%%%%

\section{On the difference of Fourier amplitudes} \label{sec:fourierdiff}
\begin{figure*}
\gridline{\fig{imgs/rn_fourierdiff.eps}{0.33\textwidth}{(a)}
	\fig{imgs/wn_fourierdiff.eps}{0.33\textwidth}{(b)}
	\fig{imgs/fourier_vs_diff_dt.eps}{0.33\textwidth}{(c)}}
          
\caption{(a) and (b): Real-valued Fourier amplitudes obtained by single light curves (top panels) and difference between two realizations of the same source light curve (bottom) in two cases: (a) Strong $1/f$ red noise and no dead time, calculated over many 500\,s segments of the light curve, and (b) no red noise and strong dead time, calculated over many 5\,s segments of the light curve. 
The red curve gives the frequency-dependent spread of the distributions, measured by the mean of the absolute values of the curves in each frequency bin. 
The different behavior of Fourier amplitude differences under pure Poisson noise and dead time noise is evident, by comparing (a) and (b).
(c) Scatter distribution of the (averaged over multiple intervals) absolute values of dead time-affected Fourier amplitudes versus the difference of Fourier amplitudes for case (b): their relation is clearly linear, with a factor $1/\sqrt{2}$. 
}
\label{fig:fourierdiff}
\end{figure*}

Let us consider two identical and independent detectors observing the same variable source, producing independent and strictly simultaneous time series, with identical binning, $\mathbf{x} = \{x_k\}_{k=1}^N$ and $\mathbf{y} = \{y_k\}_{k=1}^N$. For a stochastic process (e.g.\ $1/\nu$-type red noise), the Fourier amplitudes will vary as a function of $N_{\mathrm{phot}}P(\nu)/4$, where $P(\nu)$ (Leahy-normalized, \citealt{Leahy+83}) is the shape of the power spectrum underlying the stochastic process, and $N_{\mathrm{phot}}$ denotes the number of photons in a light curve. If the two detectors observe the same source simultaneously, the amplitudes and phases of the stochastic process will be shared among $\mathbf{x}$ and $\mathbf{y}$, while each light curve will be affected \textit{independently} by both the photon counting noise in the detector, as well as the dead time process. 
Dead time can be considered a convolution on the signal \citep{Vikhlinin+94}. 
As such, for the convolution theorem we will have that the Fourier transform $\mathcal{F}$ of dead time-affected light curves will result in a \textit{product} of the Fourier transform of the signal $\mathcal{S}$ times the Fourier transform of the dead time filter $\mathcal{D}$:
\begin{equation}
\mathcal{F}(\nu) = \mathcal{S}(\nu)\cdot\mathcal{D}(\nu)
\end{equation}
For a large enough number of data points $N$, the complex Fourier amplitudes $S_j$ will be composed of a sum of two independent random normal variables: $S_j = S_{sj} + S_{nj}$, with $\Re (S_{sj}) \sim \Normal(0, \sigma_{sj}^2)$ and $\Re(S_{nj}) \sim \Normal(0, \sigma_n^2)$, and similarly for the imaginary parts.
$\sigma_{sj}^2 = \sigma_{s}^2(\nu) = N_\mathrm{phot}P(\nu)/4$ (where $N_{\mathrm{phot}} = \sum_{k=1}^{N}{x_k}$) is given by the power spectrum of the underlying stochastic process and is frequency-dependent. However, $\sigma_n^2 = N_\mathrm{phot}/2$ is not. 
Note that $S_{xsj} = S_{ysj}$, because the amplitudes of the stationary noise process will be the same for the Fourier transforms of $\mathbf{x}$ and $\mathbf{y}$, while the components due to white noise differ between the two time series.
Moreover, the dead time filter will only depend on the mean count rate, which is again the same in the two light curves.
Thus, the difference between the Fourier amplitudes for the two time series $\mathbf{x}$ and $\mathbf{y}$ will be:
\begin{equation}
F_{xj} - F_{yj} = (S_{xj} - S_{yj})\cdot D_j = (S_{xnj} - S_{ynj})\cdot D_j
\end{equation}
So, in practice, the real and imaginary parts of the Fourier amplitude \textit{difference} between two simultaneous lightcurves of the same signal from identical detectors will be a random variate of the form $\Normal(0, 2\sigma_{n}^2)$ for both the imaginary and real parts, \textit{multiplied} by the Fourier transform of the dead time filter.
But the squared norm of the latter \textit{is also what is distorting the periodograms}!
However, in the case of periodograms the source signal is mingled with the shape of $|\mathcal{D}|^2$, while in this case we have a \textit{constant-scatter} random variable which is modulated by the same shape. Therefore, we can try to extract the shape of $|\mathcal{D}|^2$ from the Fourier amplitude differences from the two channels, and use it to correct the shape of the periodogram.

%
%
%The resulting Fourier amplitudes will be of the form
%
%\begin{eqnarray}
%A_{xj} &=& A_{xsj} + A_{xdj} + A_{xnj} \nonumber \\
%B_{xj} &=& B_{xsj} + B_{xdj} + B_{xnj} \, ,
%\end{eqnarray}
%
%\noindent where $A_{xsj}$ and $B_{xsj}$ denote the real and imaginary components of the signal power in the Fourier amplitudes,  $A_{xdj}$ and $B_{xdj}$ denote the variance introduced by dead time, and $A_{xnj}$ and $B_{xnj}$ similarly denote the white noise components in the Fourier amplitudes.
%For a large enough number of data points $N$, the Fourier amplitudes $A_{xj}$ and $B_{xj}$ will be composed of a sum of three independent random normal variables, with $A_{xsj} \sim \Normal(0, \sigma_{sj}^2)$,  $A_{xdj} \sim \Normal(0, \sigma_{dj}^2)$ and $A_{xnj} \sim \Normal(0, \sigma_n^2)$, where $\sigma_{sj}^2 = \sigma_{s}^2(\nu) = N_\mathrm{phot}P(\nu)/4$ is given by the power spectrum of the underlying stochastic process, $P_j = P(\nu_j)$, $\sigma_{dj}^2$ is an unknown, frequency-dependent variance introduced by dead time, and $N_{\mathrm{phot}} = \sum_{k=1}^{N}{x_k}$ is the integrated flux in the light curve. We also have $\sigma_n^2 = N_\mathrm{phot}/2$, and hence the combined distributions become
%
%\begin{eqnarray}
%A_{xj} &\sim & \Normal(0, \sigma_{sj}^2 + \sigma_{dj}^2 + \sigma_{n}^2) \nonumber \\
%A_{yj} &\sim & \Normal(0, \sigma_{sj}^2 + \sigma_{dj}^2 + \sigma_{n}^2) \nonumber \, .
%\end{eqnarray}
%
%\noindent Similar expressions can be found for $A_{yj}$ and $B_{yj}$, respectively. It is important to note that $A_{xsj} = A_{ysj}$ and similarly $B_{xsj} = B_{ysj}$, that is, the amplitudes of the stationary noise process will be the same for the Fourier transforms of $\mathbf{x}$ and $\mathbf{y}$, while the components due to dead time and white noise differ between the two time series.
%
%As depicted in Figure~\ref{fig:fourierdiff}, the correlation between Fourier amplitudes implies that their difference will be independent of the source-induced variability $P(\nu_j)$ and will again be distributed following a normal distribution 
%
%\[
%A_{xj} - A_{yj} \sim \Normal(0, 2\sigma_{dj}^2 + 2\sigma_{n}^2) \; .
%\]
%
%\noindent The difference in Fourier amplitudes effectively separates the frequency-dependent effects of source variability and variability due to detector effects.

%%%%%%%%%%%%%%%%%%%%%%%% SECTION 3 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The FAD method} \label{sec:fad}
\subsection{Data simulation} \label{sec:data}
All simulated and real data sets in this paper were produced and/or analyzed with a combination of the two Python libraries \texttt{stingray}%
\footnote{The library is under heavy development.
    For this work we used the version identified by the hash \texttt{3e64f3d}.
    See \href{https://github.com/StingraySoftware/notebooks/}{https://github.com/StingraySoftware/notebooks/} for tutorials on simulations, light curve production and timing analysis with Stingray}
\citep{huppenkothen2016} and \texttt{HENDRICS} v.\texttt{3.0b2} \citep[formerly known as MaLTPyNT;][]{2015ascl.soft02021B}, both based on Astropy \citep{astropy2013}.

We used the same procedure and algorithms described by \citet{Bachetti+15}, Section 4, that we briefly recall here together with references to the methods and classes of the libraries above where these steps are implemented.
%The classes in the \texttt{stingray.simulate} module were used to simulate light curves with a given noise profile. 
We used the \citet{timmer1995} method to create a noise-affected light curve starting from a given power spectral shape. 
This method is implemented in the \texttt{stingray.simulate} module.
%We first created the noisy light curves and then used an acceptance-rejection method to obtain simulated events. 
This step needs to be done carefully: if the initial light curves contain significant random noise, the process for the creation of events creates a random variate on the top of the local count rate - which is varying randomly already - producing a non-Poissonian final light curve. 
So, we initially simulated light curves with a very high ``count rate'' - so that the Poisson noise was relatively small - then renormalized the light curves to the wanted (lower) count rate and \rms and finally used these light curves to simulate event lists using the rejection sampling, implemented in the \texttt{stingray.Eventlist.simulate\_times()} method.
Then, the \texttt{hendrics.fake.filter\_for\_deadtime()} function was used to apply a non-paralyzable dead time of 2.5\,ms to the simulated event lists. For more details on the simulated data sets, see also Section \ref{sec:correction} and the available Jupyter notebooks%
\footnote{\href{https://github.com/matteobachetti/deadtime-paper-II}{https://github.com/matteobachetti/deadtime-paper-II}} \citep[for a description of Jupyter notebooks, see][]{kluyver2016jupyter}.
After producing these synthetic event lists, we started the standard timing analysis: we produced light curves with a bin time of $\sim0.122$\,ms, and calculated power spectral products (cospectrum, periodogram) over segments of these light curves using \texttt{stingray}.


%\subsection{Cyg X-1 \nustar dataset}
%We tested the method also on real data of several bright sources observed by \nustar.
%As an example, we report here one such test done on \nustar data of the black hole binary Cyg~X-1 together with the steps to reproduce our analysis, using the linked Jupyter notebook if needed.
%We downloaded the observation directory of \nustar ObsID 30001011009 (UT 2014-10-04) from the HEASARC using the custom \texttt{heasarc\_pipelines} package (Bachetti et al., ASCL identifier requested). 
%Equivalently, this download can be done using the online tools provided by HEASARC (e.g. \texttt{xamin}).
%Starting from the standard cleaned science event files distributed by HEASARC, we applied a barycenter correction using the FTOOL \texttt{barycorr} shipped with HEASOFT 6.21 with the clock correction file n. 71 from the \nustar CALDB.
%We selected photons in a region of 50\arcsec around the nominal position of Cyg X-1 using the FTOOL \texttt{fselect}.%
%\footnote{To use the method on different sources, it is sufficient to download a different ObsID and change the region file containing the position of the source}.
%We used the scripts contained in \texttt{HENDRICS} to load the event lists for the two detectors FPMA and FPMB, calibrate them to translate the PI channels into energy values, and produced light curves with photons from 3 to 79 keV and binned with uniform time bins of 1/4096$\sim2.44\cdot10^{-4}$\,sec%
%\footnote{This procedure uses the scripts \texttt{HENreadfile}, \texttt{HENcalibrate} and \texttt{HENlcurve}, as described at\\ \href{http://hendrics.readthedocs.io/en/master/tutorials/quicklook.html}{http://hendrics.readthedocs.io/en/master/tutorials/quicklook.html}}.


%%%%%%%%%%%%%%%%%%%%%%%% SECTION 4 %%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{First test: white noise} \label{sec:wndeadtime}

\begin{figure*}
\plotone{imgs/before_and_after.eps}
%\plotone{imgs/pds_pdf.pdf}
\caption{Periodogram and cospectrum, before and after FAD correction, for a pure white noise light curve. 
The deadtime-driven distortion of the white noise level in the periodogram, and the frequency-dependent modulation of the \rms in both spectra, disappear after applying the FAD correction. 
Spectra were calculated over 2-sec intervals and averaged, to decrease the scatter and highlight the distortion of powers.}
\label{fig:comparison}
\end{figure*}

\begin{figure*}
\plotone{imgs/pds_pdf.pdf}
\caption{PDF of non-averaged powers in the cospectrum (red) and the periodogram (black), before the FAD correction and after, shown as a histogram. 
After correction, the powers follow remarkably well the expected Laplace and $\chi^2_2$ distributions respectively, as highlighted by the overplotted probability density functions (PDF).}
\label{fig:dist}
\end{figure*}

Let us simulate two constant light curves with an incident mean count rate of 400 counts/sec and a dead time of 2.5 ms, as we would expect from two identical detectors observing the same stable X-ray source.
The Fourier amplitudes of the light curves from the two detectors are heavily distorted by dead time, with the characteristic damped oscillator-like shape \citep{Vikhlinin+94,Zhang+95}  (Figure ~\ref{fig:fourierdiff}, middle panel). 
As laid out in Section \ref{sec:fourierdiff}, the difference of Fourier amplitudes from two independent but identical detectors shows no source variability, but \textit{still shows the same distortion} due to dead time.
Therefore, using the difference between the Fourier amplitudes in two detectors, we can in principle renormalize the power spectrum so that only the source variability alters its otherwise flat shape.

As shown in Figure~\ref{fig:fourierdiff} (right panel), the single-channel Fourier amplitudes are proportional to the difference of the Fourier amplitudes in different realizations, with a constant factor $1/\sqrt{2}$.
Therefore, we expect that the periodogram will be proportional to the square of the Fourier amplitude difference, divided by 2.
Let us try to \textit{divide the power spectrum by a smoothed version of the squared Fourier differences}, and multiply by 2.
For smoothing, we used a Gaussian running window with a window width of 50 bins.
Given that the initial binning had 50 bins/Hz, this interpolation allows an aggressive smoothing over bins whose y value does not change significantly.
We call this procedure the \textbf{Fourier Amplitude Difference} (hereafter FAD) \textbf{correction}.

The correction is depicted in Figure~\ref{fig:comparison}. 
Starting from a heavily distorted distribution of the powers, applying the FAD correction ``flattens'' remarkably well the white noise level of the periodogram and the distribution of the scatter of the white noise periodogram and cospectrum. 
Also, it reinstates a correct distribution of powers, following the expected $\chi^2_2$ distribution \citep{Lewin+88} very closely. 
Analogously, the corrected cospectrum will follow the expected Laplace distribution \citep{Huppenkothen & Bachetti, sub.}.
While the original dead time-affected cospectrum had a frequency-dependent modification to the \rms level, the FAD-corrected cospectrum gets back to a frequency-independent shape, like in the dead time-free case.

%%%%%%%%%%%%%%%%%%%%%%%% SECTION 5 %%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{The FAD algorithm in detail} \label{sec:fad}
In practice, the FAD correction algorithm in a generic case would work as follows:
\begin{enumerate}
\item split the two light curves in segments as one would do to calculate standard averaged periodograms;
\item for each pair of light curve segments: 
	\begin{itemize}
	\item calculate the Fourier transform of each channel separately, and then of the summed channels (hereafter total-intensity);
	\item save the unnormalized Fourier amplitudes;
	\item multiply these Fourier amplitudes by $\sqrt{2/N_{ph}}$ (that would give Leahy-normalized periodograms if squared);
	\item subtract the Leahy-normalized Fourier amplitudes of the two channels between them, \textit{take the absolute value}, and obtain this way the Fourier Amplitude Differences (FAD);
	\item \textit{smooth} the FAD using a Gaussian-window interpolation with a large number of bins, in our case all the bins contained in 1-2 Hz;
	\item use the separated single-channel and total-intensity \textit{unnormalized} Fourier amplitudes to calculate the periodograms;
	\item use the unnormalized Fourier amplitudes from channels A and B to calculate the cospectrum;
	\item divide all periodograms and the cospectrum by the smoothed and squared FAD, and multiply by 2.
	\end{itemize}
\item normalize the periodograms to the wanted normalization (Leahy or fractional \rms).
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%% SECTION 6 %%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{FAD correction of generic variable periodograms} \label{sec:correction}

\begin{figure*}
    \plotone{imgs/four_qpos.eps}
    \caption{Periodograms and cospectra from a simulation with four Lorentzian features (at 50, 200, 300 and 400 Hz) with 40-Hz full with at half maximum (FWHM). 
    We plotted and fitted periodograms and cospectra before and after applying the dead time filter
    The total \rms before dead time was 40\% and the incident photon flux 400 ct/s. 
    After applying a dead time of 2.5 ms like in \nustar, the ``detected'' photon flux decreased to $\sim$200 ct/s as expected. 
    As can be seen from the best-fit curves, there is no significant difference between FAD-normalized and deadtime-free periodograms and cospectra.
    For comparison, we also plot the cospectrum without FAD (pink), showing very different amplitudes for the four Lorentzians, due to dead time.
    }
    \label{fig:pds}
\end{figure*}

We are now ready to verify the last step: is the FAD-corrected power spectrum equivalent (albeit with some loss of sensitivity due to the lower number of photons) to the dead time-free power spectrum?
To test this, we produced a number of different synthetic datasets as explained in Section~\ref{sec:wndeadtime}, containing different combinations of QPOs and broadband noise components. 
We first calculated the periodogram and cospectrum of the dead time-free data, averaged over 128-s intervals.
Then, we applied a dead time filter to the event list and applied the FAD correction, as described in Section~\ref{sec:fad}

All spectra were then expressed in fractional \rms \citep{BelloniHasinger90,Miyamoto+91} normalization, where the integral of the fitted power spectral components over the frequency returns directly its fractional \rms.
In the \rms normalization, the values of each point of the periodogram, after white noise subtraction, should be consistent between the dead time-free and the FAD-corrected periodograms.
We fitted all spectra with the model which produced the simulated data and checked if the \rms values were consistent with the fit on the dead time-free periodogram.
To calculate this \rms, we fitted the spectra with two Lorentzian components, and integrated the model over the full frequency range.
For periodograms, the model included also a constant offset to account for the white noise level.
An example of this analysis is shown in Figure~\ref{fig:pds}.


\subsection{Simulation results and discussion}\label{sec:caveat}
\begin{figure*}
    \plotone{imgs/errors.pdf}
    \caption{Relative overestimation of FAD with respect to \rms, versus \rms, as calculated from the cospectrum.  
    We encoded the frequency of the feature in the color, and the incident rate in the size of the scatter points.
    From this visualization we see two regimes: below $\sim$40\% fractional \rms, the errors are dominated by statistical errors. 
    These errors will simply decrease when we average more data, as we expect from statistical errors.
    Over $\sim$40\% fractional \rms, the errors are significantly skewed towards an overestimation of the \rms, and this is 
    clearly truer when the incident rate \textit{and} the \rms are high.}
    \label{fig:errors}
\end{figure*}

The simulations show that the shape of the periodogram is precisely corrected by the FAD procedure if (1) \textit{the input light curves have the same count rate} and (2) \textit{for values of the input count rate and \rms that are not too extreme}. 
The first caveat turns out, in practice, to be only a big issue for the single-channel periodogram, but \textit{not} for cospectra and total-intensity periodograms. 
At high count rates, single-channel periodograms are corrected very well only if the two channels have very similar count rates, with the requirement being unsurprisingly stricter and stricter as the count rate increases.
However, we find that the total-intensity periodogram and the cospectrum remains well corrected by the FAD even if the count rate in the two channels differs by 30\% in most cases.
Therefore, we recommend to use the FAD very carefully with single-channel periodograms, which should not be an issue given that the total-intensity periodogram is more sensitive and more convenient to use anyway. 
A comparison with the cospectrum, that is not affected by white noise level distortions, is always recommended. 

The second caveat needs some attention. 
We find that the FAD correction consistently overestimates the integrated \rms when the count rate and \rms are \textit{both} very high, \textit{in particular at low frequency} (See Figure~\ref{fig:errors}).
At $\sim$200 ct/s and 30\% \rms, the relative error is below 5\% (meaning that if the \rms is 30\%, the measured \rms is between 30 and 32\%!) and it is symmetrically distributed around 0, as expected from statistical errors. 
At higher incident rates and \rms, the error distribution skews towards positive relative errors, implying an overestimation of the \rms.
This should not be a problem in most cases, where the \rms is used as a rough indicator for spectral state.
If very precise measurements of \rms are needed (for example, to calculate \rms/energy spectra), it is safer to account for this through simulations.
As a rough rule-of-thumb, the relative error on the fractional \rms increases \textit{linearly} with the count rate and \textit{quadratically} with \rms.
A practical way to estimate this effect during analysis is to apply the FAD, obtain a best fit model, calculate the \rms, then use the codes we shared with the Jupyter notebooks to simulate a number of realizations of the light curve, evaluating what is the amount of overestimation involved.

%%%%%%%%%%%%%%%%%%%%%%%% SECTION 6 %%%%%%%%%%%%%%%%%%%%%%%%%%
%
%\section{Example: Cyg X-1 \nustar dataset}
%We tested the method also on real data of several bright sources observed by \nustar.
%As an example, we report here one such test done on \nustar data of the black hole binary Cyg~X-1 together with the steps to reproduce our analysis, using the linked Jupyter notebook if needed.
%
%Cyg X-1 is a persistent black hole X-ray binary, alternating soft and hard spectral states with distinct timing and spectral features \citep[see, e.g., ][]{Grinberg+13}.
%We downloaded standard data products of 
%The observation we analyze here was taken during the source's soft state, that is characterized by a non-thermal X-ray spectrum, stable radio jets and, what matters the most here, distinct aperiodic variability that is well fitted by an exponential cutoff power law with index $\sim1$ (see, e.g., \citealt{Gilfanov+00}).
%We followed the procedure described in \sref{sec:correction}, dividing the light curves in 512-s segments and smoothing the squared FAD with a Gaussian window of 1-s width (512 bins).
%The results are shown in Figure~\ref{fig:pds}, lower panel for comparison with the simulations. 
%
%We fitted the four spectra of Cyg X-1 with an exponential cutoff power law. 
%For periodograms, we added to the models an additive constant to account for the white noise level.
%In all cases, the estimates returned by the fit were consistent between the different spectra in all but the amplitude parameter of the power law curve.
%We used this amplitude to calculate the ratios between the \rms measured by the deadtime-affected cospectrum and the FAD-corrected spectra.
%The increase of \rms between the dead time-affected cospectrum and the FAD-corrected cospectrum and periodograms is consistent to 2\% with the ratio $r_{in}/r_{det}$, where $r_{in}$ is the incident count rate, and $r_{det}$ is the detected count rate,
%given by
%
%\begin{equation}
%r_{det} = \frac{r_{in}}{1 + \deadt r_{in}}
%\end{equation} 
%(using the standard non-paralyzable dead time formula, where \deadt is dead time) which is the drop of \rms expected from the effect of dead time \citep{Bachetti+15}.

%%%%%%%%%%%%%%%%%%%%%%%% SECTION 7 %%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Conclusions}
In this Letter we described a method to correct the normalization of dead time-affected periodograms.
This method is valid in principle for 
1) correcting the shape of the periodogram, eliminating the well known pattern produced by dead time, and 
2) adjusting the white noise standard deviation of periodogram and cospectra to its correct value at all frequencies.
In general, we recommend applying the FAD correction to both the periodogram and the cospectrum. 
The periodogram, if obtained by the sum of the light curves, can yield a higher signal-to-noise ratio.
However, the white noise level subtraction is not always very precise due to mismatches in the mean count rate in the two light curves. 
A comparison with the FAD-corrected cospectrum, to verify visually the white noise subtraction, is always recommended: the white noise subtraction is the most important step when calculating the significance of a given feature in the periodogram \citep[e.g.][]{Barret+12,Huppenkothen+17}.
The cospectrum has indeed the advantage of not requiring white noise level subtraction.

A number of jupyter notebooks is available the address \href{https://github.com/matteobachetti/deadtime-paper-II}{https://github.com/matteobachetti/deadtime-paper-II} to reproduce the full analysis plotted in the Figures of this paper, plus more examples of application of these techniques to simulated and real data.
The full algorithm described in Section~\ref{sec:fad} is contained in the \texttt{fad\_correction.py} file in the notebooks directory, for reference.
In all cases, we find that the adjustment of the white noise standard deviation in the periodogram and the cospectrum works remarkably well, allowing to make a confident analysis of X-ray variability even in sources where this was precluded until now.
Only in cases where the count rate and the \rms are \textit{both} very high (>1000 ct/s incident, >40\% resp.), the FAD correction leads to an overestimation the \rms, even if the white noise level of the periodogram remains flat.
In these case, we provide some example simulation code to estimate this effect in the notebooks.
This software will be merged into the main repository of \texttt{stingray} before publication.


\acknowledgments
We thank David W. Hogg for useful discussions on the topic of Fourier analysis.
MB is supported in part by the Italian Space Agency through agreement ASI-INAF n.2017-12-H.0 and ASI-INFN agreement n.2017-13-H.0.
DH is supported by the James Arthur Postdoctoral Fellowship and the Moore-Sloan Data Science Environment at New York University.

\bibliographystyle{aasjournal}
%\bibliography{deadtime,papers3}
\begin{thebibliography}{}
\expandafter\ifx\csname natexlab\endcsname\relax\def\natexlab#1{#1}\fi
\providecommand{\url}[1]{\href{#1}{#1}}

\bibitem[{{Astropy Collaboration} {et~al.}(2013){Astropy Collaboration},
  {Robitaille}, {Tollerud}, {Greenfield}, {Droettboom}, {Bray}, {Aldcroft},
  {Davis}, {Ginsburg}, {Price-Whelan}, {Kerzendorf}, {Conley}, {Crighton},
  {Barbary}, {Muna}, {Ferguson}, {Grollier}, {Parikh}, {Nair}, {Unther},
  {Deil}, {Woillez}, {Conseil}, {Kramer}, {Turner}, {Singer}, {Fox}, {Weaver},
  {Zabalza}, {Edwards}, {Azalee Bostroem}, {Burke}, {Casey}, {Crawford},
  {Dencheva}, {Ely}, {Jenness}, {Labrie}, {Lim}, {Pierfederici}, {Pontzen},
  {Ptak}, {Refsdal}, {Servillat}, \& {Streicher}}]{astropy2013}
{Astropy Collaboration}, {Robitaille}, T.~P., {Tollerud}, E.~J., {et~al.} 2013,
  \aap, 558, A33

\bibitem[{Bachetti(2015)}]{2015ascl.soft02021B}
Bachetti, M. 2015, Astrophysics Source Code Library, ascl:1502.021

\bibitem[{Bachetti {et~al.}(2015)Bachetti, Harrison, Cook, Tomsick, Schmid,
  Grefenstette, Barret, Boggs, Christensen, Craig, Fabian, F{\"u}rst, Gandhi,
  Hailey, Kara, Maccarone, Miller, Pottschmidt, Stern, Uttley, Walton, Wilms,
  \& Zhang}]{Bachetti+15}
Bachetti, M., Harrison, F.~A., Cook, R., {et~al.} 2015, ApJ, 800, 109

\bibitem[{Barret \& Vaughan(2012)}]{Barret+12}
Barret, D., \& Vaughan, S. 2012, ApJ, 746, 131

\bibitem[{Belloni \& Hasinger(1990)}]{BelloniHasinger90}
Belloni, T., \& Hasinger, G. 1990, A{\&}A, 230, 103

\bibitem[{Bowyer {et~al.}(1965)Bowyer, Byram, Chubb, \& Friedman}]{Bowyer+65}
Bowyer, S., Byram, E.~T., Chubb, T.~A., \& Friedman, H. 1965, Astronomical
  Observations from Space Vehicles, 23, 227

\bibitem[{Gilfanov {et~al.}(2000)Gilfanov, Churazov, \&
  Revnivtsev}]{Gilfanov+00}
Gilfanov, M., Churazov, E., \& Revnivtsev, M. 2000, MNRAS, 316, 923

\bibitem[{Grinberg {et~al.}(2013)Grinberg, Hell, Pottschmidt, B{\"o}ck, Nowak,
  Rodriguez, Bodaghee, Cadolle~Bel, Case, Hanke, K{\"u}hnel, Markoff, Pooley,
  Rothschild, Tomsick, Wilson-Hodge, \& Wilms}]{Grinberg+13}
Grinberg, V., Hell, N., Pottschmidt, K., {et~al.} 2013, 554, 88

\bibitem[{{Huppenkothen} {et~al.}(2016){Huppenkothen}, {Bachetti}, {Stevens},
  {Migliari}, \& {Balm}}]{huppenkothen2016}
{Huppenkothen}, D., {Bachetti}, M., {Stevens}, A.~L., {Migliari}, S., \&
  {Balm}, P. 2016, {Stingray: Spectral-timing software}, Astrophysics Source
  Code Library, , , ascl:1608.001

\bibitem[{Huppenkothen {et~al.}(2017)Huppenkothen, Younes, Ingram, Kouveliotou,
  G{\"o}{\u{g}}{\"u}{\c s}, Bachetti, Sanchez-Fernandez, Chenevez, Motta,
  van~der Klis, Granot, Gehrels, Kuulkers, Tomsick, \&
  Walton}]{Huppenkothen+17}
Huppenkothen, D., Younes, G., Ingram, A., {et~al.} 2017, ApJ, 834, 90

\bibitem[{Kluyver {et~al.}(2016)Kluyver, Ragan-Kelley, P{\'e}rez, Granger,
  Bussonnier, Frederic, Kelley, Hamrick, Grout, Corlay,
  {et~al.}}]{kluyver2016jupyter}
Kluyver, T., Ragan-Kelley, B., P{\'e}rez, F., {et~al.} 2016, in ELPUB, 87--90

\bibitem[{Leahy {et~al.}(1983)Leahy, Darbro, Elsner, Weisskopf, Kahn,
  Sutherland, \& Grindlay}]{Leahy+83}
Leahy, D.~A., Darbro, W., Elsner, R.~F., {et~al.} 1983, ApJ, 266, 160

\bibitem[{Lewin {et~al.}(1988)Lewin, van Paradijs, \& van~der Klis}]{Lewin+88}
Lewin, W. H.~G., van Paradijs, J., \& van~der Klis, M. 1988, SSRv, 46, 273

\bibitem[{Miyamoto {et~al.}(1991)Miyamoto, Kimura, Kitamoto, Dotani, \&
  Ebisawa}]{Miyamoto+91}
Miyamoto, S., Kimura, K., Kitamoto, S., Dotani, T., \& Ebisawa, K. 1991, ApJ,
  383, 784

\bibitem[{{Timmer} \& {Koenig}(1995)}]{timmer1995}
{Timmer}, J., \& {Koenig}, M. 1995, \aap, 300, 707

\bibitem[{Vikhlinin {et~al.}(1994)Vikhlinin, Churazov, \&
  Gilfanov}]{Vikhlinin+94}
Vikhlinin, A., Churazov, E., \& Gilfanov, M. 1994, 287, 73

\bibitem[{Zhang {et~al.}(1995)Zhang, Jahoda, Swank, Morgan, \&
  Giles}]{Zhang+95}
Zhang, W., Jahoda, K., Swank, J.~H., Morgan, E.~H., \& Giles, A.~B. 1995, ApJ,
  449, 930

\end{thebibliography}

\end{document}

% End of file `sample61.tex'.
